<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Organization Chart</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // ============================================
    // SUPABASE CONFIGURATION
    // ============================================
    // IMPORTANT: Add your Supabase anon key below!
    // Find it at: Settings → API → Project API keys → anon public
    const SUPABASE_URL = 'https://izlleygwccfunfrcjtvc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6bGxleWd3Y2NmdW5mcmNqdHZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MDQyNTYsImV4cCI6MjA4Mzk4MDI1Nn0.XQNQIkxIg6D6MFqtYMn5QJ4H0lLIpUXkhWAvsuEF190';

    // Initialize Supabase client (only if key is configured and library loaded)
    let supabase = null;
    try {
      if (SUPABASE_ANON_KEY !== 'YOUR_ANON_KEY_HERE' && window.supabase) {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }
    } catch (e) {
      console.error('Failed to initialize Supabase:', e);
    }

    // ============================================

    const initialOrgData = {
      id: "1",
      name: "Cody Plofker",
      title: "CEO",
      department: "Executive",
      children: [
        {
          id: "2",
          name: "Chrissy Devries",
          title: "COO",
          department: "Operations",
          children: []
        },
        {
          id: "3",
          name: "Juliet Baker",
          title: "VP of Retail",
          department: "Retail",
          children: []
        },
        {
          id: "4",
          name: "Kirsten Walpert",
          title: "SVP of Marketing",
          department: "Marketing",
          children: [
            {
              id: "4-1",
              name: "Payal Patel",
              title: "Senior Director of Brand Marketing",
              department: "Brand Marketing",
              children: [
                { id: "4-1-1", name: "Samantha O'Hara", title: "Sr. Copywriter", department: "Brand Marketing", children: [] },
                { id: "4-1-2", name: "Charlotte Newman", title: "Associate Manager of Social Media", department: "Marketing", children: [] },
                {
                  id: "4-1-3",
                  name: "Genevieve Outwater",
                  title: "Senior Manager of Marketing",
                  department: "Marketing",
                  children: [
                    { id: "4-1-3-1", name: "Carly Steakin", title: "Marketing Operations Manager", department: "Marketing", children: [] }
                  ]
                }
              ]
            },
            {
              id: "4-2",
              name: "Augustina",
              title: "Creative Strategist, Paid Social",
              department: "Remote",
              remote: true,
              monthlyRate: "$4,000",
              children: []
            },
            {
              id: "4-3",
              name: "Erin Silverman",
              title: "Creative Director",
              department: "Creative",
              children: [
                { id: "4-3-1", name: "Cameron Falco", title: "Video Editor", department: "Creative", children: [] },
                { id: "4-3-2", name: "Joseph Dioslaki", title: "Jr. Content Producer & Editor", department: "Creative", children: [] },
                { id: "4-3-3", name: "Diana Horan", title: "Senior Graphic Designer", department: "Creative", children: [] },
                { id: "4-3-4", name: "Emma Silverman", title: "Content Producer", department: "Creative", children: [] }
              ]
            }
          ]
        },
        {
          id: "7",
          name: "Whitney Blau",
          title: "Director of Growth & eCommerce",
          department: "Growth Marketing",
          children: [
            {
              id: "7-1",
              name: "Sam Brady",
              title: "Growth Marketing Manager",
              department: "Growth Marketing",
              children: [
                { id: "7-1-1", name: "Huzaifa", title: "Growth Associate", department: "Remote", remote: true, monthlyRate: "$5,500", children: [] },
                { id: "7-1-2", name: "Charl", title: "Google/YouTube Specialist", department: "Remote", remote: true, monthlyRate: "$6,000", children: [] }
              ]
            },
            { id: "7-2", name: "Rebecca", title: "Ecom Manager", department: "Remote", remote: true, monthlyRate: "$3,160", children: [] },
            {
              id: "7-3",
              name: "Berenice Laciar",
              title: "Video Editor Lead",
              department: "Remote",
              remote: true,
              monthlyRate: "$3,200",
              children: [
                { id: "7-3-1", name: "Pablo Escobar", title: "Video Editor", department: "Remote", remote: true, monthlyRate: "$2,500", children: [] },
                { id: "7-3-2", name: "Franco Vetere", title: "Video Editor", department: "Remote", remote: true, monthlyRate: "$2,000", children: [] },
                { id: "7-3-3", name: "Fiorella", title: "Video Editor", department: "Remote", remote: true, monthlyRate: "$2,000", children: [] }
              ]
            },
            { id: "7-4", name: "Alma Medina", title: "Senior Manager of Retention", department: "Remote", remote: true, monthlyRate: "$4,500", children: [] }
          ]
        },
        {
          id: "8",
          name: "Vacant",
          title: "Director of Influencer and Affiliate",
          department: "Vacant",
          children: [
            { id: "8-1", name: "Isabella Munoz", title: "Influencer Marketing Assistant", department: "Remote", remote: true, monthlyRate: "$2,100", children: [] }
          ]
        },
        {
          id: "9",
          name: "Virginia",
          title: "TikTok Shop Manager",
          department: "Remote",
          remote: true,
          monthlyRate: "$5,500",
          children: []
        },
        {
          id: "5",
          name: "Vacant",
          title: "VP of Finance",
          department: "Vacant",
          children: []
        },
        {
          id: "6",
          name: "Vacant",
          title: "VP of People",
          department: "Vacant",
          children: []
        }
      ]
    };

    const departmentColors = {
      "Executive": { bg: "bg-purple-100", border: "border-purple-400", text: "text-purple-800" },
      "Operations": { bg: "bg-orange-100", border: "border-orange-400", text: "text-orange-800" },
      "Finance": { bg: "bg-green-100", border: "border-green-400", text: "text-green-800" },
      "Retail": { bg: "bg-blue-100", border: "border-blue-400", text: "text-blue-800" },
      "Marketing": { bg: "bg-pink-100", border: "border-pink-400", text: "text-pink-800" },
      "People": { bg: "bg-yellow-100", border: "border-yellow-400", text: "text-yellow-800" },
      "Vacant": { bg: "bg-gray-200", border: "border-gray-400 border-dashed", text: "text-gray-500" },
      "Creative": { bg: "bg-indigo-100", border: "border-indigo-400", text: "text-indigo-800" },
      "Growth Marketing": { bg: "bg-rose-100", border: "border-rose-400", text: "text-rose-800" },
      "Brand Marketing": { bg: "bg-amber-100", border: "border-amber-400", text: "text-amber-800" },
      "Remote": { bg: "bg-teal-50", border: "border-teal-400 border-dashed", text: "text-teal-700" }
    };

    // Icons as SVG components
    const ChevronDown = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="m6 9 6 6 6-6"/>
      </svg>
    );

    const ChevronRight = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="m9 18 6-6-6-6"/>
      </svg>
    );

    const UserIcon = ({ className }) => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
    );

    const PlusIcon = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-green-500">
        <path d="M5 12h14"/><path d="M12 5v14"/>
      </svg>
    );

    const EditIcon = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500">
        <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/>
      </svg>
    );

    const TrashIcon = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-500">
        <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
      </svg>
    );

    const ZoomInIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/><path d="M11 8v6"/><path d="M8 11h6"/>
      </svg>
    );

    const ZoomOutIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/><path d="M8 11h6"/>
      </svg>
    );

    const ResetIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/>
      </svg>
    );

    const GlobeIcon = ({ size = 14 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
        <path d="M2 12h20"/>
      </svg>
    );

    const EyeIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>
    );

    const EyeOffIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49"/>
        <path d="M14.084 14.158a3 3 0 0 1-4.242-4.242"/>
        <path d="M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143"/>
        <path d="m2 2 20 20"/>
      </svg>
    );

    // Department hierarchy - child departments that should be included when filtering by parent
    const departmentHierarchy = {
      "Marketing": ["Brand Marketing", "Growth Marketing", "Creative"],
      "Executive": [],
      "Operations": [],
      "Finance": [],
      "Retail": [],
      "People": [],
      "Vacant": [],
      "Creative": [],
      "Growth Marketing": [],
      "Brand Marketing": [],
      "Remote": []
    };

    // Check if a department matches the filter (including hierarchy)
    const deptMatchesFilter = (dept, filter) => {
      if (!filter || filter === 'all') return true;
      if (dept === filter) return true;
      // Check if dept is a child of the filter
      return departmentHierarchy[filter]?.includes(dept) || false;
    };

    const OrgNode = ({ node, level, onUpdate, onAdd, onDelete, onMove, onReorder, onSwapRoles, draggedNode, setDraggedNode, draggedRole, setDraggedRole, showRemote, deptFilter, siblingIndex = 0, siblingCount = 1 }) => {
      const [isExpanded, setIsExpanded] = useState(level < 3);
      const [isEditing, setIsEditing] = useState(false);
      const [editData, setEditData] = useState({
        name: node.name,
        title: node.title,
        department: node.department,
        subdepartment: node.subdepartment || "",
        remote: node.remote || false,
        monthlyRate: node.monthlyRate || "",
        salary: node.salary || "",
        vacant: node.vacant || node.name === "Vacant" || false,
        startDate: node.startDate || ""
      });
      const [isDragOver, setIsDragOver] = useState(false);
      const [isRoleDragOver, setIsRoleDragOver] = useState(false);

      // Filter children based on showRemote and department filter
      let visibleChildren = showRemote
        ? node.children
        : node.children?.filter(child => !child.remote) || [];

      // Apply department filter (including hierarchy)
      if (deptFilter && deptFilter !== 'all') {
        visibleChildren = visibleChildren.filter(child => {
          // Check if child or any descendant matches the filter (including sub-departments)
          const matchesDept = (n) => {
            if (deptMatchesFilter(n.department, deptFilter)) return true;
            return n.children?.some(c => matchesDept(c)) || false;
          };
          return matchesDept(child);
        });
      }

      const hasVisibleChildren = visibleChildren && visibleChildren.length > 0;
      // Use gray/vacant styling if node is marked vacant OR name is "Vacant"
      const isVacant = node.vacant || node.name === "Vacant";
      const colors = isVacant ? departmentColors["Vacant"] : (departmentColors[node.department] || departmentColors["Executive"]);
      const isBeingDragged = draggedNode?.id === node.id;
      const isRemote = node.remote;

      // If this node is remote and we're hiding remote, return null
      if (!showRemote && isRemote) {
        return null;
      }

      // If department filter is set and this node doesn't match (and isn't an ancestor), dim it
      const matchesFilter = !deptFilter || deptFilter === 'all' || deptMatchesFilter(node.department, deptFilter);

      const handleSave = () => {
        onUpdate(node.id, editData);
        setIsEditing(false);
      };

      const handleAddChild = () => {
        const newChild = {
          id: `${node.id}-${Date.now()}`,
          name: "New Employee",
          title: "Title",
          department: node.department,
          children: []
        };
        onAdd(node.id, newChild);
        setIsExpanded(true);
      };

      const handleDragStart = (e) => {
        if (level === 0) return;
        e.stopPropagation();
        setDraggedNode(node);
        e.dataTransfer.effectAllowed = 'move';
      };

      const handleDragEnd = () => {
        setDraggedNode(null);
        setIsDragOver(false);
      };

      const handleDragOver = (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (draggedNode && draggedNode.id !== node.id) {
          setIsDragOver(true);
        }
      };

      const handleDragLeave = (e) => {
        e.preventDefault();
        setIsDragOver(false);
      };

      const handleDrop = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragOver(false);
        setIsRoleDragOver(false);

        // Check what type of drag we're handling
        const dragType = e.dataTransfer.getData('text/plain');

        if (dragType === 'role' && draggedRole && draggedRole.id !== node.id) {
          // Role swap mode
          onSwapRoles(draggedRole.id, node.id);
        } else if (draggedNode && draggedNode.id !== node.id) {
          // Person move mode
          onMove(draggedNode.id, node.id);
        }
      };

      // Role-specific drag handlers (for the dedicated swap handle)
      const handleRoleDragStart = (e) => {
        e.stopPropagation();
        setDraggedRole({ id: node.id, title: node.title, department: node.department });
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', 'role');
      };

      const handleRoleDragEnd = () => {
        setDraggedRole(null);
      };

      const handleRoleDragOver = (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (draggedRole && draggedRole.id !== node.id) {
          setIsRoleDragOver(true);
        }
      };

      const handleRoleDragLeave = () => {
        setIsRoleDragOver(false);
      };

      return (
        <div className="flex flex-col items-center">
          <div
            draggable={level > 0 && !isEditing}
            onDragStart={handleDragStart}
            onDragEnd={handleDragEnd}
            onDragOver={(e) => { handleDragOver(e); handleRoleDragOver(e); }}
            onDragLeave={(e) => { handleDragLeave(e); handleRoleDragLeave(); }}
            onDrop={handleDrop}
            className={`relative ${colors.bg} ${colors.border} border-2 rounded-lg p-3 min-w-64 shadow-md hover:shadow-lg transition-all group
              ${level > 0 ? 'cursor-grab active:cursor-grabbing' : ''}
              ${isBeingDragged ? 'opacity-50 scale-95' : ''}
              ${draggedRole?.id === node.id ? 'opacity-50 scale-95' : ''}
              ${isDragOver && !draggedRole ? 'ring-4 ring-blue-400 ring-opacity-50 scale-105' : ''}
              ${isRoleDragOver ? 'ring-4 ring-purple-400 ring-opacity-50 scale-105' : ''}
            `}>

            {/* Remote Badge */}
            {isRemote && (
              <div className="absolute -top-2 -right-2 bg-teal-500 text-white px-2 py-0.5 rounded-full text-xs font-medium flex items-center gap-1 shadow-md">
                <GlobeIcon size={12} />
                Remote
              </div>
            )}

            {isEditing ? (
              <div className="space-y-2">
                <input
                  type="text"
                  value={editData.name}
                  onChange={(e) => setEditData({...editData, name: e.target.value})}
                  className="w-full px-2 py-1 border rounded text-sm"
                  placeholder="Name"
                />
                <input
                  type="text"
                  value={editData.title}
                  onChange={(e) => setEditData({...editData, title: e.target.value})}
                  className="w-full px-2 py-1 border rounded text-sm"
                  placeholder="Title"
                />
                <select
                  value={editData.department}
                  onChange={(e) => setEditData({...editData, department: e.target.value})}
                  className="w-full px-2 py-1 border rounded text-sm"
                >
                  {Object.keys(departmentColors).filter(d => d !== 'Vacant').map(dept => (
                    <option key={dept} value={dept}>{dept}</option>
                  ))}
                </select>
                <input
                  type="text"
                  value={editData.subdepartment}
                  onChange={(e) => setEditData({...editData, subdepartment: e.target.value})}
                  className="w-full px-2 py-1 border rounded text-sm"
                  placeholder="Subdepartment (e.g. Paid Social)"
                />
                <label className="flex items-center gap-2 text-sm text-gray-600">
                  <input
                    type="checkbox"
                    checked={editData.vacant}
                    onChange={(e) => setEditData({...editData, vacant: e.target.checked})}
                    className="rounded"
                  />
                  Vacant Position
                </label>
                <input
                  type="text"
                  value={editData.salary}
                  onChange={(e) => setEditData({...editData, salary: e.target.value})}
                  className="w-full px-2 py-1 border rounded text-sm"
                  placeholder="Annual Salary (e.g. $120,000)"
                />
                <div className="flex items-center gap-2">
                  <label className="text-sm text-gray-600">Start Date:</label>
                  <input
                    type="date"
                    value={editData.startDate}
                    onChange={(e) => setEditData({...editData, startDate: e.target.value})}
                    className="flex-1 px-2 py-1 border rounded text-sm"
                  />
                </div>
                <label className="flex items-center gap-2 text-sm text-gray-600">
                  <input
                    type="checkbox"
                    checked={editData.remote}
                    onChange={(e) => setEditData({...editData, remote: e.target.checked, department: e.target.checked ? "Remote" : editData.department})}
                    className="rounded"
                  />
                  Remote/Overseas
                </label>
                {editData.remote && (
                  <input
                    type="text"
                    value={editData.monthlyRate}
                    onChange={(e) => setEditData({...editData, monthlyRate: e.target.value})}
                    className="w-full px-2 py-1 border rounded text-sm"
                    placeholder="Monthly Rate (e.g. $3,000)"
                  />
                )}
                <div className="flex gap-2">
                  <button onClick={handleSave} className="flex-1 bg-green-500 text-white px-2 py-1 rounded text-sm hover:bg-green-600">Save</button>
                  <button onClick={() => setIsEditing(false)} className="flex-1 bg-gray-300 px-2 py-1 rounded text-sm hover:bg-gray-400">Cancel</button>
                </div>
              </div>
            ) : (
              <>
                <div className="flex items-start gap-2">
                  <div className={`p-2 rounded-full ${colors.border} border bg-white`}>
                    <UserIcon className={colors.text} />
                  </div>
                  <div className="flex-1">
                    <div className="font-semibold text-gray-800">{node.name}</div>
                    <div className="flex items-center gap-1">
                      <div className={`text-sm ${colors.text}`}>{node.title}</div>
                      {/* Role swap drag handle */}
                      <div
                        draggable
                        onDragStart={handleRoleDragStart}
                        onDragEnd={handleRoleDragEnd}
                        className="opacity-0 group-hover:opacity-100 cursor-grab active:cursor-grabbing p-1 hover:bg-purple-100 rounded transition-all"
                        title="Drag to swap role with another person"
                        onClick={(e) => e.stopPropagation()}
                      >
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-purple-500">
                          <path d="M7 16V4m0 0L3 8m4-4l4 4M17 8v12m0 0l4-4m-4 4l-4-4"/>
                        </svg>
                      </div>
                    </div>
                    <div className="text-xs text-gray-500 mt-1">
                      <span className={isVacant ? 'text-gray-400 italic' : ''}>
                        {node.department}{node.subdepartment && ` › ${node.subdepartment}`}
                        {isVacant && ' (Vacant)'}
                      </span>
                      {node.salary && (
                        <span className="ml-2 text-green-600 font-medium">{node.salary}/yr</span>
                      )}
                      {node.monthlyRate && (
                        <span className="ml-2 text-teal-600 font-medium">{node.monthlyRate}/mo</span>
                      )}
                    </div>
                  </div>
                </div>

                {/* Reorder arrows - show on hover when there are siblings */}
                {level > 0 && siblingCount > 1 && (
                  <div className="absolute top-1/2 -translate-y-1/2 -left-6 opacity-0 group-hover:opacity-100 transition-opacity">
                    {siblingIndex > 0 && (
                      <button
                        onClick={(e) => { e.stopPropagation(); onReorder(node.id, -1); }}
                        className="p-1 bg-white rounded-full shadow hover:bg-gray-100"
                        title="Move left"
                      >
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="m15 18-6-6 6-6"/>
                        </svg>
                      </button>
                    )}
                  </div>
                )}
                {level > 0 && siblingCount > 1 && (
                  <div className="absolute top-1/2 -translate-y-1/2 -right-6 opacity-0 group-hover:opacity-100 transition-opacity">
                    {siblingIndex < siblingCount - 1 && (
                      <button
                        onClick={(e) => { e.stopPropagation(); onReorder(node.id, 1); }}
                        className="p-1 bg-white rounded-full shadow hover:bg-gray-100"
                        title="Move right"
                      >
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="m9 18 6-6-6-6"/>
                        </svg>
                      </button>
                    )}
                  </div>
                )}

                <div className="absolute -bottom-3 left-1/2 transform -translate-x-1/2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white rounded-full shadow px-1 py-0.5">
                  <button onClick={() => setIsEditing(true)} className="p-1 hover:bg-gray-100 rounded" title="Edit">
                    <EditIcon />
                  </button>
                  <button onClick={handleAddChild} className="p-1 hover:bg-gray-100 rounded" title="Add Report">
                    <PlusIcon />
                  </button>
                  {level > 0 && (
                    <button onClick={() => onDelete(node.id)} className="p-1 hover:bg-gray-100 rounded" title="Remove">
                      <TrashIcon />
                    </button>
                  )}
                </div>
              </>
            )}

            {hasVisibleChildren && !isEditing && (
              <button
                onClick={() => setIsExpanded(!isExpanded)}
                className="absolute -bottom-3 right-2 bg-white border rounded-full p-0.5 shadow hover:bg-gray-50"
              >
                {isExpanded ? <ChevronDown /> : <ChevronRight />}
              </button>
            )}
          </div>

          {hasVisibleChildren && isExpanded && (
            <>
              <div className="w-0.5 h-8 bg-gray-300"></div>
              <div className="relative">
                {visibleChildren.length > 1 && (
                  <div
                    className="absolute top-0 left-1/2 transform -translate-x-1/2 h-0.5 bg-gray-300"
                    style={{ width: `calc(100% - 256px)` }}
                  ></div>
                )}
                <div className="flex gap-8">
                  {visibleChildren.map((child, index) => (
                    <div key={child.id} className="flex flex-col items-center">
                      {visibleChildren.length > 1 && <div className="w-0.5 h-8 bg-gray-300"></div>}
                      <OrgNode
                        node={child}
                        level={level + 1}
                        onUpdate={onUpdate}
                        onAdd={onAdd}
                        onDelete={onDelete}
                        onMove={onMove}
                        onReorder={onReorder}
                        onSwapRoles={onSwapRoles}
                        draggedNode={draggedNode}
                        setDraggedNode={setDraggedNode}
                        draggedRole={draggedRole}
                        setDraggedRole={setDraggedRole}
                        showRemote={showRemote}
                        deptFilter={deptFilter}
                        siblingIndex={index}
                        siblingCount={visibleChildren.length}
                      />
                    </div>
                  ))}
                </div>
              </div>
            </>
          )}
        </div>
      );
    };

    // Deep clone helper
    const deepClone = (obj) => JSON.parse(JSON.stringify(obj));

    // Future state - Virginia reports to Director of Influencer and Affiliate
    const initialFutureOrgData = {
      id: "1",
      name: "Cody Plofker",
      title: "CEO",
      department: "Executive",
      children: [
        {
          id: "2",
          name: "Chrissy Devries",
          title: "COO",
          department: "Operations",
          children: []
        },
        {
          id: "3",
          name: "Juliet Baker",
          title: "VP of Retail",
          department: "Retail",
          children: []
        },
        {
          id: "4",
          name: "Kirsten Walpert",
          title: "SVP of Marketing",
          department: "Marketing",
          children: [
            {
              id: "4-1",
              name: "Payal Patel",
              title: "Senior Director of Brand Marketing",
              department: "Brand Marketing",
              children: [
                { id: "4-1-1", name: "Samantha O'Hara", title: "Sr. Copywriter", department: "Brand Marketing", children: [] },
                { id: "4-1-2", name: "Charlotte Newman", title: "Associate Manager of Social Media", department: "Marketing", children: [] },
                {
                  id: "4-1-3",
                  name: "Genevieve Outwater",
                  title: "Senior Manager of Marketing",
                  department: "Marketing",
                  children: [
                    { id: "4-1-3-1", name: "Carly Steakin", title: "Marketing Operations Manager", department: "Marketing", children: [] }
                  ]
                }
              ]
            },
            {
              id: "4-2",
              name: "Augustina",
              title: "Creative Strategist, Paid Social",
              department: "Remote",
              remote: true,
              monthlyRate: "$4,000",
              children: []
            },
            {
              id: "4-3",
              name: "Erin Silverman",
              title: "Creative Director",
              department: "Creative",
              children: [
                { id: "4-3-1", name: "Cameron Falco", title: "Video Editor", department: "Creative", children: [] },
                { id: "4-3-2", name: "Joseph Dioslaki", title: "Jr. Content Producer & Editor", department: "Creative", children: [] },
                { id: "4-3-3", name: "Diana Horan", title: "Senior Graphic Designer", department: "Creative", children: [] },
                { id: "4-3-4", name: "Emma Silverman", title: "Content Producer", department: "Creative", children: [] }
              ]
            }
          ]
        },
        {
          id: "7",
          name: "Whitney Blau",
          title: "Director of Growth & eCommerce",
          department: "Growth Marketing",
          children: [
            {
              id: "7-1",
              name: "Sam Brady",
              title: "Growth Marketing Manager",
              department: "Growth Marketing",
              children: [
                { id: "7-1-1", name: "Huzaifa", title: "Growth Associate", department: "Remote", remote: true, monthlyRate: "$5,500", children: [] },
                { id: "7-1-2", name: "Charl", title: "Google/YouTube Specialist", department: "Remote", remote: true, monthlyRate: "$6,000", children: [] }
              ]
            },
            { id: "7-2", name: "Rebecca", title: "Ecom Manager", department: "Remote", remote: true, monthlyRate: "$3,160", children: [] },
            {
              id: "7-3",
              name: "Berenice Laciar",
              title: "Video Editor Lead",
              department: "Remote",
              remote: true,
              monthlyRate: "$3,200",
              children: [
                { id: "7-3-1", name: "Pablo Escobar", title: "Video Editor", department: "Remote", remote: true, monthlyRate: "$2,500", children: [] },
                { id: "7-3-2", name: "Franco Vetere", title: "Video Editor", department: "Remote", remote: true, monthlyRate: "$2,000", children: [] },
                { id: "7-3-3", name: "Fiorella", title: "Video Editor", department: "Remote", remote: true, monthlyRate: "$2,000", children: [] }
              ]
            },
            { id: "7-4", name: "Alma Medina", title: "Senior Manager of Retention", department: "Remote", remote: true, monthlyRate: "$4,500", children: [] }
          ]
        },
        {
          id: "8",
          name: "Vacant",
          title: "Director of Influencer and Affiliate",
          department: "Vacant",
          children: [
            { id: "8-1", name: "Isabella Munoz", title: "Influencer Marketing Assistant", department: "Remote", remote: true, monthlyRate: "$2,100", children: [] },
            { id: "8-2", name: "Virginia", title: "TikTok Shop Manager", department: "Remote", remote: true, monthlyRate: "$5,500", children: [] }
          ]
        },
        {
          id: "5",
          name: "Vacant",
          title: "VP of Finance",
          department: "Vacant",
          children: []
        },
        {
          id: "6",
          name: "Vacant",
          title: "VP of People",
          department: "Vacant",
          children: []
        }
      ]
    };

    // Budget Table Component - Spreadsheet style with months as columns
    const BudgetTable = ({ scenarios, activeScenario, onSelectScenario, onAddScenario, onDeleteScenario, onRenameScenario, showCurrentOnly }) => {
      const [newScenarioName, setNewScenarioName] = useState('');
      const [editingName, setEditingName] = useState(null);
      const [tempName, setTempName] = useState('');
      const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());

      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

      // Flatten org tree to array
      const flattenOrg = (node, result = []) => {
        const startDate = node.startDate ? new Date(node.startDate) : null;
        const isNew = startDate && startDate > new Date();
        if (!showCurrentOnly || !isNew) {
          result.push({
            id: node.id,
            name: node.name,
            title: node.title,
            department: node.department,
            subdepartment: node.subdepartment,
            salary: node.salary,
            monthlyRate: node.monthlyRate,
            startDate: node.startDate,
            remote: node.remote,
            vacant: node.vacant || node.name === 'Vacant',
            isNew
          });
        }
        node.children?.forEach(child => flattenOrg(child, result));
        return result;
      };

      // Parse salary/rate string to number
      const parseAmount = (str) => {
        if (!str) return 0;
        return parseFloat(str.replace(/[^0-9.]/g, '')) || 0;
      };

      // Get monthly cost for a person in a given month
      const getMonthlyCost = (emp, monthIndex) => {
        const startDate = emp.startDate ? new Date(emp.startDate) : null;
        const monthDate = new Date(selectedYear, monthIndex, 1);

        // If they have a start date and it's after this month, return 0
        if (startDate && startDate > monthDate) {
          return { amount: 0, isFuture: true };
        }

        // Remote workers use monthlyRate, others use salary/12
        if (emp.monthlyRate) {
          return { amount: parseAmount(emp.monthlyRate), isFuture: false };
        } else if (emp.salary) {
          return { amount: parseAmount(emp.salary) / 12, isFuture: false };
        }
        return { amount: 0, isFuture: false };
      };

      const scenarioData = scenarios[activeScenario];
      const employees = scenarioData ? flattenOrg(scenarioData) : [];

      // Separate remote and in-house
      const remoteEmployees = employees.filter(e => e.remote);
      const inHouseEmployees = employees.filter(e => !e.remote && !e.vacant);
      const vacantPositions = employees.filter(e => e.vacant);

      // Calculate totals per month
      const monthlyTotals = months.map((_, idx) => {
        return employees.reduce((sum, emp) => sum + getMonthlyCost(emp, idx).amount, 0);
      });
      const yearTotal = monthlyTotals.reduce((a, b) => a + b, 0);

      const renderEmployeeRow = (emp, idx) => (
        <tr key={emp.id} className={`border-b hover:bg-gray-50 ${emp.vacant ? 'bg-gray-50 text-gray-400 italic' : ''}`}>
          <td className="p-2 sticky left-0 bg-white border-r font-medium min-w-48">
            {emp.name}
            {emp.isNew && <span className="ml-2 px-1.5 py-0.5 bg-green-100 text-green-700 text-xs rounded">NEW</span>}
            {emp.vacant && <span className="ml-2 px-1.5 py-0.5 bg-gray-200 text-gray-500 text-xs rounded">VACANT</span>}
          </td>
          <td className="p-2 text-xs text-gray-500 min-w-32">{emp.title}</td>
          {months.map((_, monthIdx) => {
            const { amount, isFuture } = getMonthlyCost(emp, monthIdx);
            return (
              <td key={monthIdx} className={`p-2 text-right text-sm ${isFuture ? 'text-gray-300' : amount > 0 ? 'text-gray-700' : 'text-gray-300'}`}>
                {amount > 0 ? `$${Math.round(amount).toLocaleString()}` : '—'}
              </td>
            );
          })}
          <td className="p-2 text-right font-semibold text-gray-800 bg-gray-50">
            ${Math.round(months.reduce((sum, _, idx) => sum + getMonthlyCost(emp, idx).amount, 0)).toLocaleString()}
          </td>
        </tr>
      );

      return (
        <div className="bg-white rounded-xl shadow-lg p-6">
          {/* Scenario Tabs */}
          <div className="flex items-center gap-2 mb-6 flex-wrap">
            {Object.keys(scenarios).map(name => (
              <div key={name} className="relative group">
                {editingName === name ? (
                  <input
                    type="text"
                    value={tempName}
                    onChange={(e) => setTempName(e.target.value)}
                    onBlur={() => {
                      if (tempName.trim() && tempName !== name) onRenameScenario(name, tempName.trim());
                      setEditingName(null);
                    }}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') {
                        if (tempName.trim() && tempName !== name) onRenameScenario(name, tempName.trim());
                        setEditingName(null);
                      }
                    }}
                    className="px-3 py-2 border rounded text-sm w-32"
                    autoFocus
                  />
                ) : (
                  <button
                    onClick={() => onSelectScenario(name)}
                    onDoubleClick={() => { setEditingName(name); setTempName(name); }}
                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                      activeScenario === name ? 'bg-indigo-500 text-white shadow' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                    }`}
                  >
                    {name}
                  </button>
                )}
                {Object.keys(scenarios).length > 1 && activeScenario !== name && name !== 'Current' && name !== 'Future' && (
                  <button onClick={() => onDeleteScenario(name)} className="absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full text-xs opacity-0 group-hover:opacity-100">×</button>
                )}
              </div>
            ))}
            <div className="flex items-center gap-2 ml-4">
              <input
                type="text"
                value={newScenarioName}
                onChange={(e) => setNewScenarioName(e.target.value)}
                placeholder="New scenario..."
                className="px-3 py-2 border rounded text-sm w-36"
              />
              <button
                onClick={() => { if (newScenarioName.trim()) { onAddScenario(newScenarioName.trim()); setNewScenarioName(''); }}}
                className="px-3 py-2 bg-green-500 text-white rounded text-sm hover:bg-green-600"
              >+ Add</button>
            </div>
            <div className="ml-auto flex items-center gap-2">
              <label className="text-sm text-gray-600">Year:</label>
              <select value={selectedYear} onChange={(e) => setSelectedYear(Number(e.target.value))} className="px-3 py-2 border rounded text-sm">
                {[2024, 2025, 2026, 2027].map(y => <option key={y} value={y}>{y}</option>)}
              </select>
            </div>
          </div>

          {/* Summary Cards */}
          <div className="grid grid-cols-4 gap-4 mb-6">
            <div className="bg-blue-50 rounded-lg p-4">
              <div className="text-2xl font-bold text-blue-700">{employees.length}</div>
              <div className="text-sm text-blue-600">Total Headcount</div>
            </div>
            <div className="bg-teal-50 rounded-lg p-4">
              <div className="text-2xl font-bold text-teal-700">{remoteEmployees.length}</div>
              <div className="text-sm text-teal-600">Remote/Contractors</div>
            </div>
            <div className="bg-green-50 rounded-lg p-4">
              <div className="text-2xl font-bold text-green-700">{inHouseEmployees.length}</div>
              <div className="text-sm text-green-600">In-House</div>
            </div>
            <div className="bg-purple-50 rounded-lg p-4">
              <div className="text-2xl font-bold text-purple-700">${Math.round(yearTotal).toLocaleString()}</div>
              <div className="text-sm text-purple-600">Total {selectedYear} Cost</div>
            </div>
          </div>

          {/* Budget Spreadsheet */}
          <div className="overflow-x-auto border rounded-lg">
            <table className="w-full text-sm">
              <thead className="bg-gray-100 sticky top-0">
                <tr>
                  <th className="p-3 text-left sticky left-0 bg-gray-100 border-r min-w-48">Name</th>
                  <th className="p-3 text-left min-w-32">Role</th>
                  {months.map(m => (
                    <th key={m} className="p-3 text-right min-w-20">{m}</th>
                  ))}
                  <th className="p-3 text-right bg-gray-200 min-w-24">Total</th>
                </tr>
              </thead>
              <tbody>
                {/* Remote/Contractors Section */}
                <tr className="bg-teal-50">
                  <td colSpan={14} className="p-2 font-semibold text-teal-800 sticky left-0 bg-teal-50">
                    Remote / Contractors ({remoteEmployees.length})
                  </td>
                </tr>
                {remoteEmployees.map(renderEmployeeRow)}

                {/* In-House Section */}
                <tr className="bg-green-50">
                  <td colSpan={14} className="p-2 font-semibold text-green-800 sticky left-0 bg-green-50">
                    In-House ({inHouseEmployees.length})
                  </td>
                </tr>
                {inHouseEmployees.map(renderEmployeeRow)}

                {/* Vacant Positions */}
                {vacantPositions.length > 0 && (
                  <>
                    <tr className="bg-gray-100">
                      <td colSpan={14} className="p-2 font-semibold text-gray-600 sticky left-0 bg-gray-100">
                        Vacant Positions ({vacantPositions.length})
                      </td>
                    </tr>
                    {vacantPositions.map(renderEmployeeRow)}
                  </>
                )}

                {/* Totals Row */}
                <tr className="bg-purple-100 font-bold">
                  <td className="p-3 sticky left-0 bg-purple-100 border-r text-purple-800">TOTAL</td>
                  <td className="p-3"></td>
                  {monthlyTotals.map((total, idx) => (
                    <td key={idx} className="p-3 text-right text-purple-800">
                      ${Math.round(total).toLocaleString()}
                    </td>
                  ))}
                  <td className="p-3 text-right bg-purple-200 text-purple-900">
                    ${Math.round(yearTotal).toLocaleString()}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          {/* Scenario Comparison */}
          {Object.keys(scenarios).length > 1 && (
            <div className="mt-8 pt-6 border-t">
              <h3 className="text-lg font-semibold mb-4">Scenario Comparison ({selectedYear})</h3>
              <table className="w-full text-sm">
                <thead>
                  <tr className="bg-gray-50">
                    <th className="text-left p-2">Scenario</th>
                    <th className="text-right p-2">Headcount</th>
                    <th className="text-right p-2">Remote</th>
                    <th className="text-right p-2">In-House</th>
                    <th className="text-right p-2">Annual Cost</th>
                  </tr>
                </thead>
                <tbody>
                  {Object.entries(scenarios).map(([name, data]) => {
                    const emps = data ? flattenOrg(data) : [];
                    const remote = emps.filter(e => e.remote).length;
                    const inHouse = emps.filter(e => !e.remote && !e.vacant).length;
                    const total = emps.reduce((sum, emp) => {
                      return sum + months.reduce((mSum, _, idx) => mSum + getMonthlyCost(emp, idx).amount, 0);
                    }, 0);
                    return (
                      <tr key={name} className={`border-b ${name === activeScenario ? 'bg-indigo-50' : ''}`}>
                        <td className="p-2 font-medium">{name}</td>
                        <td className="p-2 text-right">{emps.length}</td>
                        <td className="p-2 text-right text-teal-600">{remote}</td>
                        <td className="p-2 text-right text-green-600">{inHouse}</td>
                        <td className="p-2 text-right text-purple-600 font-semibold">${Math.round(total).toLocaleString()}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}
        </div>
      );
    };

    function OrgChart() {
      // Load from localStorage or use defaults (with error handling)
      const [currentOrgData, setCurrentOrgData] = useState(() => {
        try {
          const saved = localStorage.getItem('orgChart_current');
          return saved ? JSON.parse(saved) : initialOrgData;
        } catch (e) {
          console.error('Error loading current org data:', e);
          return initialOrgData;
        }
      });
      const [futureOrgData, setFutureOrgData] = useState(() => {
        try {
          const saved = localStorage.getItem('orgChart_future');
          return saved ? JSON.parse(saved) : initialFutureOrgData;
        } catch (e) {
          console.error('Error loading future org data:', e);
          return initialFutureOrgData;
        }
      });
      // Scenarios for budget planning
      const [scenarios, setScenarios] = useState(() => {
        try {
          const saved = localStorage.getItem('orgChart_scenarios');
          return saved ? JSON.parse(saved) : {};
        } catch (e) {
          console.error('Error loading scenarios:', e);
          return {};
        }
      });
      const [activeScenario, setActiveScenario] = useState('Current');
      const [pageView, setPageView] = useState('chart'); // 'chart' or 'budget'
      const [showCurrentOnly, setShowCurrentOnly] = useState(false);

      const [viewMode, setViewMode] = useState('current');
      const [zoom, setZoom] = useState(1);
      const [draggedNode, setDraggedNode] = useState(null);
      const [draggedRole, setDraggedRole] = useState(null);
      const [showRemote, setShowRemote] = useState(true);
      const [deptFilter, setDeptFilter] = useState('all');
      const [compDisplay, setCompDisplay] = useState('annual'); // 'annual' or 'monthly'
      const [syncStatus, setSyncStatus] = useState(supabase ? 'loading' : 'local'); // 'loading', 'synced', 'saving', 'error', 'local'
      const [isInitialized, setIsInitialized] = useState(false);

      // Sync scenarios with current/future data
      useEffect(() => {
        setScenarios(prev => ({
          ...prev,
          'Current': currentOrgData,
          'Future': futureOrgData
        }));
      }, [currentOrgData, futureOrgData]);

      // Save scenarios to localStorage
      useEffect(() => {
        localStorage.setItem('orgChart_scenarios', JSON.stringify(scenarios));
      }, [scenarios]);

      // Scenario management functions
      const addScenario = (name) => {
        if (scenarios[name]) return;
        setScenarios(prev => ({
          ...prev,
          [name]: JSON.parse(JSON.stringify(scenarios[activeScenario] || currentOrgData))
        }));
        setActiveScenario(name);
      };

      const deleteScenario = (name) => {
        if (name === 'Current' || name === 'Future') return;
        const { [name]: _, ...rest } = scenarios;
        setScenarios(rest);
        if (activeScenario === name) {
          setActiveScenario('Current');
        }
      };

      const renameScenario = (oldName, newName) => {
        if (oldName === 'Current' || oldName === 'Future' || scenarios[newName]) return;
        const { [oldName]: data, ...rest } = scenarios;
        setScenarios({ ...rest, [newName]: data });
        if (activeScenario === oldName) {
          setActiveScenario(newName);
        }
      };

      // Load from Supabase on mount
      useEffect(() => {
        if (!supabase) {
          setIsInitialized(true);
          return;
        }

        const loadFromSupabase = async () => {
          try {
            setSyncStatus('loading');
            const { data, error } = await supabase
              .from('org_data')
              .select('*')
              .eq('id', 'main')
              .single();

            if (error) {
              // If no data exists yet, insert the current localStorage data
              if (error.code === 'PGRST116') {
                console.log('No data in Supabase yet, will save current state');
                setSyncStatus('synced');
                setIsInitialized(true);
                return;
              }
              throw error;
            }

            if (data) {
              // Only load if there's actual data
              if (data.current_data && Object.keys(data.current_data).length > 0) {
                setCurrentOrgData(data.current_data);
              }
              if (data.future_data && Object.keys(data.future_data).length > 0) {
                setFutureOrgData(data.future_data);
              }
              setSyncStatus('synced');
            }
            setIsInitialized(true);
          } catch (err) {
            console.error('Error loading from Supabase:', err);
            setSyncStatus('error');
            setIsInitialized(true);
          }
        };

        loadFromSupabase();
      }, []);

      // Save to Supabase when data changes (with debounce)
      useEffect(() => {
        if (!supabase || !isInitialized) return;

        const saveToSupabase = async () => {
          setSyncStatus('saving');
          try {
            const { error } = await supabase
              .from('org_data')
              .upsert({
                id: 'main',
                current_data: currentOrgData,
                future_data: futureOrgData,
                updated_at: new Date().toISOString()
              });

            if (error) throw error;
            setSyncStatus('synced');
          } catch (err) {
            console.error('Error saving to Supabase:', err);
            setSyncStatus('error');
          }
        };

        // Debounce saves to avoid too many requests
        const timer = setTimeout(saveToSupabase, 1000);
        return () => clearTimeout(timer);
      }, [currentOrgData, futureOrgData, isInitialized]);

      // Save to localStorage when data changes (as backup)
      useEffect(() => {
        localStorage.setItem('orgChart_current', JSON.stringify(currentOrgData));
      }, [currentOrgData]);

      useEffect(() => {
        localStorage.setItem('orgChart_future', JSON.stringify(futureOrgData));
      }, [futureOrgData]);

      const orgData = viewMode === 'current' ? currentOrgData : futureOrgData;
      const setOrgData = viewMode === 'current' ? setCurrentOrgData : setFutureOrgData;

      const zoomIn = () => setZoom(prev => Math.min(prev + 0.1, 2));
      const zoomOut = () => setZoom(prev => Math.max(prev - 0.1, 0.3));
      const resetZoom = () => setZoom(1);

      const copyCurrentToFuture = () => {
        setFutureOrgData(deepClone(currentOrgData));
      };

      const copyFutureToCurrent = () => {
        if (window.confirm('This will replace your Current org chart with the Future state. Are you sure?')) {
          setCurrentOrgData(deepClone(futureOrgData));
        }
      };

      const updateNode = (id, updates) => {
        const updateRecursive = (node) => {
          if (node.id === id) {
            return { ...node, ...updates };
          }
          return {
            ...node,
            children: node.children.map(updateRecursive)
          };
        };
        setOrgData(updateRecursive(orgData));
      };

      const addChild = (parentId, newChild) => {
        const addRecursive = (node) => {
          if (node.id === parentId) {
            return {
              ...node,
              children: [...node.children, newChild]
            };
          }
          return {
            ...node,
            children: node.children.map(addRecursive)
          };
        };
        setOrgData(addRecursive(orgData));
      };

      const deleteNode = (id) => {
        const deleteRecursive = (node) => {
          return {
            ...node,
            children: node.children
              .filter(child => child.id !== id)
              .map(deleteRecursive)
          };
        };
        setOrgData(deleteRecursive(orgData));
      };

      const moveNode = (nodeId, newParentId) => {
        let movedNode = null;

        const findAndRemove = (node) => {
          const foundIndex = node.children.findIndex(child => child.id === nodeId);
          if (foundIndex !== -1) {
            movedNode = node.children[foundIndex];
            return {
              ...node,
              children: node.children.filter(child => child.id !== nodeId)
            };
          }
          return {
            ...node,
            children: node.children.map(findAndRemove)
          };
        };

        const treeWithoutNode = findAndRemove(orgData);

        if (!movedNode) return;

        const isDescendant = (node, targetId) => {
          if (node.id === targetId) return true;
          return node.children.some(child => isDescendant(child, targetId));
        };

        if (isDescendant(movedNode, newParentId)) {
          alert("Can't move a person under their own report!");
          return;
        }

        const addToParent = (node) => {
          if (node.id === newParentId) {
            return {
              ...node,
              children: [...node.children, movedNode]
            };
          }
          return {
            ...node,
            children: node.children.map(addToParent)
          };
        };

        setOrgData(addToParent(treeWithoutNode));
      };

      const swapRoles = (sourceId, targetId) => {
        // Find both nodes first
        const findNode = (node, id) => {
          if (node.id === id) return node;
          for (const child of node.children) {
            const found = findNode(child, id);
            if (found) return found;
          }
          return null;
        };

        const sourceNode = findNode(orgData, sourceId);
        const targetNode = findNode(orgData, targetId);

        if (!sourceNode || !targetNode) return;

        // Swap the roles (title and department)
        const swapRecursive = (node) => {
          if (node.id === sourceId) {
            return {
              ...node,
              title: targetNode.title,
              department: targetNode.department,
              children: node.children.map(swapRecursive)
            };
          }
          if (node.id === targetId) {
            return {
              ...node,
              title: sourceNode.title,
              department: sourceNode.department,
              children: node.children.map(swapRecursive)
            };
          }
          return {
            ...node,
            children: node.children.map(swapRecursive)
          };
        };

        setOrgData(swapRecursive(orgData));
        setDraggedRole(null);
      };

      const reorderNode = (nodeId, direction) => {
        const reorderInParent = (node) => {
          const childIndex = node.children.findIndex(child => child.id === nodeId);
          if (childIndex !== -1) {
            const newIndex = childIndex + direction;
            if (newIndex >= 0 && newIndex < node.children.length) {
              const newChildren = [...node.children];
              const [removed] = newChildren.splice(childIndex, 1);
              newChildren.splice(newIndex, 0, removed);
              return { ...node, children: newChildren };
            }
            return node;
          }
          return {
            ...node,
            children: node.children.map(reorderInParent)
          };
        };
        setOrgData(reorderInParent(orgData));
      };

      const countEmployees = (node, includeRemote = true) => {
        if (!includeRemote && node.remote) return 0;
        const childCount = node.children?.reduce((sum, child) => sum + countEmployees(child, includeRemote), 0) || 0;
        return 1 + childCount;
      };

      const countRemote = (node) => {
        const isRemote = node.remote ? 1 : 0;
        const childCount = node.children?.reduce((sum, child) => sum + countRemote(child), 0) || 0;
        return isRemote + childCount;
      };

      const totalRemoteCost = (node) => {
        let cost = 0;
        if (node.monthlyRate) {
          const numStr = node.monthlyRate.replace(/[^0-9.]/g, '');
          cost = parseFloat(numStr) || 0;
        }
        const childCost = node.children?.reduce((sum, child) => sum + totalRemoteCost(child), 0) || 0;
        return cost + childCost;
      };

      const totalEmployees = countEmployees(orgData, true);
      const remoteCount = countRemote(orgData);
      const inHouseCount = totalEmployees - remoteCount;
      const remoteMonthlyCost = totalRemoteCost(orgData);

      // Export data as JSON file
      const exportData = () => {
        const data = {
          current: currentOrgData,
          future: futureOrgData,
          exportedAt: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `org-chart-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
      };

      // Import data from JSON file
      const importData = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (data.current) setCurrentOrgData(data.current);
            if (data.future) setFutureOrgData(data.future);
            alert('Data imported successfully!');
          } catch (err) {
            alert('Error importing file: ' + err.message);
          }
        };
        reader.readAsText(file);
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-8">
          <div className="max-w-full mx-auto">
            <div className="text-center mb-8">
              <h1 className="text-3xl font-bold text-gray-800 mb-2">Organization Chart</h1>

              {/* Page View Toggle */}
              <div className="flex justify-center gap-2 mb-4">
                <button
                  onClick={() => setPageView('chart')}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                    pageView === 'chart'
                      ? 'bg-gray-800 text-white shadow'
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  Org Chart
                </button>
                <button
                  onClick={() => setPageView('budget')}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                    pageView === 'budget'
                      ? 'bg-gray-800 text-white shadow'
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  Budget & Scenarios
                </button>
              </div>

              {/* Sync Status Indicator */}
              <div className="flex justify-center mb-2">
                {syncStatus === 'local' && (
                  <span className="text-xs px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full flex items-center gap-1">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                      <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    Local only - Add Supabase key to sync
                  </span>
                )}
                {syncStatus === 'loading' && (
                  <span className="text-xs px-3 py-1 bg-blue-100 text-blue-700 rounded-full flex items-center gap-1">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="animate-spin">
                      <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                    </svg>
                    Loading from cloud...
                  </span>
                )}
                {syncStatus === 'saving' && (
                  <span className="text-xs px-3 py-1 bg-blue-100 text-blue-700 rounded-full flex items-center gap-1">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="animate-spin">
                      <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                    </svg>
                    Saving...
                  </span>
                )}
                {syncStatus === 'synced' && (
                  <span className="text-xs px-3 py-1 bg-green-100 text-green-700 rounded-full flex items-center gap-1">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    Synced to cloud
                  </span>
                )}
                {syncStatus === 'error' && (
                  <span className="text-xs px-3 py-1 bg-red-100 text-red-700 rounded-full flex items-center gap-1">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                    Sync error - Check console
                  </span>
                )}
              </div>

              {/* Budget View */}
              {pageView === 'budget' && (
                <>
                  <div className="flex justify-center items-center gap-4 mb-4">
                    <label className="flex items-center gap-2 text-sm text-gray-600">
                      <input
                        type="checkbox"
                        checked={showCurrentOnly}
                        onChange={(e) => setShowCurrentOnly(e.target.checked)}
                        className="rounded"
                      />
                      Show current employees only (hide future hires)
                    </label>
                  </div>
                  <BudgetTable
                    scenarios={scenarios}
                    activeScenario={activeScenario}
                    onSelectScenario={setActiveScenario}
                    onAddScenario={addScenario}
                    onDeleteScenario={deleteScenario}
                    onRenameScenario={renameScenario}
                    showCurrentOnly={showCurrentOnly}
                  />
                </>
              )}

              {/* Chart View */}
              {pageView === 'chart' && (
              <>
              {/* View Mode Toggle */}
              <div className="flex justify-center items-center gap-4 mb-4">
                <div className="inline-flex rounded-lg border border-gray-300 p-1 bg-white shadow-sm">
                  <button
                    onClick={() => setViewMode('current')}
                    className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                      viewMode === 'current'
                        ? 'bg-blue-500 text-white shadow'
                        : 'text-gray-600 hover:bg-gray-100'
                    }`}
                  >
                    Current State
                  </button>
                  <button
                    onClick={() => setViewMode('future')}
                    className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                      viewMode === 'future'
                        ? 'bg-emerald-500 text-white shadow'
                        : 'text-gray-600 hover:bg-gray-100'
                    }`}
                  >
                    Future State
                  </button>
                </div>

                {viewMode === 'future' && (
                  <button
                    onClick={copyCurrentToFuture}
                    className="px-3 py-2 text-xs bg-gray-100 hover:bg-gray-200 rounded-md text-gray-600 transition-colors"
                    title="Reset Future to match Current"
                  >
                    Reset from Current
                  </button>
                )}
                {viewMode === 'future' && (
                  <button
                    onClick={copyFutureToCurrent}
                    className="px-3 py-2 text-xs bg-emerald-100 hover:bg-emerald-200 rounded-md text-emerald-700 transition-colors"
                    title="Apply Future changes to Current"
                  >
                    Apply to Current
                  </button>
                )}
              </div>

              {viewMode === 'future' && (
                <div className="mb-4 inline-block px-4 py-2 bg-emerald-50 border border-emerald-200 rounded-lg text-emerald-700 text-sm">
                  You're editing the <strong>Future State</strong> - changes here won't affect the Current org chart
                </div>
              )}

              {/* Stats Row */}
              <div className="flex justify-center gap-6 text-sm text-gray-600 mb-4">
                <span>Total: <strong>{showRemote ? totalEmployees : inHouseCount}</strong></span>
                <span>In-House: <strong>{inHouseCount}</strong></span>
                <span className="text-teal-600">Remote: <strong>{remoteCount}</strong></span>
                <span className="text-teal-600">Remote Monthly: <strong>${remoteMonthlyCost.toLocaleString()}</strong></span>
              </div>

              {/* Filter Controls */}
              <div className="flex justify-center gap-4 mb-4 flex-wrap">
                {/* Remote Toggle */}
                <button
                  onClick={() => setShowRemote(!showRemote)}
                  className={`flex items-center gap-2 px-4 py-2 rounded-lg border-2 transition-all ${
                    showRemote
                      ? 'bg-teal-50 border-teal-400 text-teal-700'
                      : 'bg-gray-100 border-gray-300 text-gray-500'
                  }`}
                >
                  {showRemote ? <EyeIcon /> : <EyeOffIcon />}
                  <GlobeIcon size={16} />
                  <span className="font-medium">{showRemote ? 'Remote' : 'No Remote'}</span>
                </button>

                {/* Department Filter */}
                <select
                  value={deptFilter}
                  onChange={(e) => setDeptFilter(e.target.value)}
                  className="px-4 py-2 rounded-lg border-2 border-gray-300 bg-white text-sm font-medium"
                >
                  <option value="all">All Departments</option>
                  {Object.keys(departmentColors).map(dept => (
                    <option key={dept} value={dept}>{dept}</option>
                  ))}
                </select>

                {/* Comp Display Toggle */}
                <button
                  onClick={() => setCompDisplay(compDisplay === 'annual' ? 'monthly' : 'annual')}
                  className="flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-green-300 bg-green-50 text-green-700 transition-all"
                >
                  <span className="font-medium">Show: {compDisplay === 'annual' ? 'Annual' : 'Monthly'}</span>
                </button>

                {/* Export/Import */}
                <button
                  onClick={exportData}
                  className="flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-blue-300 bg-blue-50 text-blue-700 transition-all hover:bg-blue-100"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                  </svg>
                  <span className="font-medium">Export</span>
                </button>
                <label className="flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-orange-300 bg-orange-50 text-orange-700 transition-all hover:bg-orange-100 cursor-pointer">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                  <span className="font-medium">Import</span>
                  <input type="file" accept=".json" onChange={importData} className="hidden" />
                </label>
              </div>

              {/* Department Legend */}
              <div className="mt-4 flex justify-center gap-3 flex-wrap">
                {Object.entries(departmentColors).map(([dept, colors]) => (
                  <button
                    key={dept}
                    onClick={() => setDeptFilter(deptFilter === dept ? 'all' : dept)}
                    className={`${colors.bg} ${colors.border} border px-3 py-1 rounded-full text-sm ${colors.text} cursor-pointer transition-all hover:scale-105 ${deptFilter === dept ? 'ring-2 ring-offset-1 ring-gray-400' : ''}`}
                  >
                    {dept}
                  </button>
                ))}
              </div>
            </div>

            {/* Zoom Controls */}
            <div className="fixed bottom-6 right-6 flex gap-2 bg-white rounded-lg shadow-lg p-2 z-50">
              <button onClick={zoomOut} className="p-2 hover:bg-gray-100 rounded" title="Zoom Out">
                <ZoomOutIcon />
              </button>
              <span className="flex items-center px-2 text-sm text-gray-600 min-w-12 justify-center">{Math.round(zoom * 100)}%</span>
              <button onClick={zoomIn} className="p-2 hover:bg-gray-100 rounded" title="Zoom In">
                <ZoomInIcon />
              </button>
              <button onClick={resetZoom} className="p-2 hover:bg-gray-100 rounded border-l ml-1" title="Reset Zoom">
                <ResetIcon />
              </button>
            </div>

            {/* Org Chart */}
            <div className="bg-white rounded-xl shadow-lg p-8 overflow-auto" style={{ maxHeight: 'calc(100vh - 300px)' }}>
              <div
                className="inline-block min-w-max transition-transform duration-200"
                style={{ transform: `scale(${zoom})`, transformOrigin: 'top center' }}
              >
                <OrgNode
                  node={orgData}
                  level={0}
                  onUpdate={updateNode}
                  onAdd={addChild}
                  onDelete={deleteNode}
                  onMove={moveNode}
                  onReorder={reorderNode}
                  onSwapRoles={swapRoles}
                  draggedNode={draggedNode}
                  setDraggedNode={setDraggedNode}
                  draggedRole={draggedRole}
                  setDraggedRole={setDraggedRole}
                  showRemote={showRemote}
                  deptFilter={deptFilter}
                />
              </div>
            </div>

            <div className="mt-6 text-center text-sm text-gray-500">
              <p><strong>Tips:</strong> Drag cards to reassign reporting | Use arrows to reorder siblings | Click departments to filter | Changes auto-save</p>
            </div>
            </>
            )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<OrgChart />);
  </script>
</body>
</html>
